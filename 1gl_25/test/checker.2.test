// TODO: make a struct here
static const int        MX_SZ = 2000;
static char             bracket_array[MX_SZ];
static int              pos = 0;

static inline bool      br_add(char c){
    //~
    if (pos < MX_SZ)) /*~*/
        bracket_array[pos++] = c;
    else {
        fprintf(stderr, "%s: %s Pos (%d) is out of range\n", __FILE__, __func__, pos);
        return false;
    }
    return true;
}

static inline void      br_fprint(FILE *f){
    fprintf(f, "pos [%d], [%s]\n", pos, bracket_array);
}

static inline void      br_print(void){
    return br_fprint(stderr);
}

static inline char      br_arc(char c){
    char ret = ' ';
    switch (c){
        case '(': ret = ')';
        break;
        case ')': ret = '(';
        break;
        case '[': ret = ']';
        break;
        case ']': ret = '[';
        break;
        case '{': ret = '}';
        break;
        case '}': ret = '{';
        break;
        default:
            fprintf(stderr, "%s: %s - unsupported sym [%c]\n", __FILE__, __func__, c);
    }
    return ret;
}

static inline bool      br_remove(char c){
    if (pos > 0){
        fprintf(stderr, "%c - %c\n", bracket_array[pos - 1], br_arc(c));
        if (bracket_array[pos - 1] == br_arc(c))
            bracket_array[--pos] = '\0';
        else {
            fprintf(stderr, "%s: %s  [%c] was expected, but [%c] is coming\n", __FILE__, __func__, br_arc(bracket_array[pos - 1]), c); 
            br_fprint(stderr);
            return false;
        }
    } else {
        fprintf(stderr, "%s: %s pos = %d - underrun\n", __FILE__, __func__, pos);
        return false;       // TODO: userraiseerror ??
    }
    return true;
}


static bool             check_input(int *p_errnum){
    int err = 0;
    int c, c2;
    int linenumber = 1;
    bool in_comm1 = false, in_comm2 = false, in_str = false, in_sym = false; // not sure about in_sym

    while ( (c = getchar()) != EOF){
        // bare case
        if (!in_comm1 && !in_comm2 && !in_str && !in_sym){
            if (c == '(' || c == '[' || c == '{')
                br_add(c);   // no check, because 2000 syms
            else if (c == ')' || c == ']' || c == '}'){
                if (!br_remove(c)){
                    fprintf(stderr, "Error on line number %d\n", linenumber);
                    err = 1;
                    break;
                }
            } else if (c == '"')
                in_str = true;
            else if (c == '\'')
                in_sym = true;
            else if (c == '/'){
                if ( (c2 = getchar()) == '/')
                    in_comm1 = true;
                else if (c2 == '*')
                    in_comm2 = true;
                else
                    ungetc(c, stdin);
            }
        } else if (in_comm1){   // ....
            if (c == '\n')
                in_comm1 = true;
        } else if (in_comm2){   /* ..... */ 
            if (c == '*'){
                if ( (c2 =  getchar()) == '/')
                    in_comm2 = false;
                else
                    ungetc(c, stdout);
            }
        } else if (in_str){
            if (c == '"')       // but what if ecraning \" ??? TODO:
                in_str = false;
        } else if (in_sym){
            if (c == '\'')
                in_sym = false;
        }
        if (c == '~')
            br_print();
        if (c == '\n')
            linenumber++;
    }
    if (p_errnum)
        *p_errnum = err;
    return err == 0;
}

